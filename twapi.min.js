// Twitch Websockets & API in javascript - TWAPI.js
// Made by skhmt, 2016. https://github.com/Skhmt/twapi.js

(function(u){function O(){function N(){h("https://api.twitch.tv/kraken/streams/"+d+"?client_id="+e+"&api_version=3",function(a){a.stream?(v=!0,A=a.stream.viewers,D=a.stream.average_fps,E=a.stream.video_height,F=a.stream.delay):v=!1});h("https://api.twitch.tv/kraken/channels/"+d+"?client_id="+e+"&api_version=3",function(a){y=a.game;z=a.status;u=a.followers;G=a.views;B=a.partner;H=a.created_at;I=a.logo;J=a.video_banner;K=a.profile_banner});h("https://api.twitch.tv/kraken/channels/"+d+"/follows?client_id="+
e+"&api_version=3&limit=100",function(a){if(a.follows){var b=!0;0<C.length&&(b=!1);for(var c=0;c<a.follows.length;c++){var L=a.follows[c].user.display_name;-1===C.indexOf(L)&&(b||q("twapiFollow",L),C.push(L))}}});h("https://tmi.twitch.tv/group/user/"+d+"/chatters?client_id="+e+"&api_version=3",function(a){if(!a.data.chatters)return console.log("No response for user list.");A=a.data.chatter_count;w.moderators=a.data.chatters.moderators.slice();w.staff=a.data.chatters.staff.slice();w.admins=a.data.chatters.admins.slice();
w.global_mods=a.data.chatters.global_mods.slice();w.viewers=a.data.chatters.viewers.slice()});setTimeout(function(){document.querySelector("#twapiJsonpContainer").innerHTML="";N()},1E4)}function P(){h("https://api.twitch.tv/kraken/chat/"+d+"/badges?api_version=3",function(a){null!=a.subscriber&&(M=a.subscriber.image)})}var b={},e="",m="",x="",d="",n,p,v=!1,y="",z="",u="",G="",B="",A="",D="",E="",F="",M="",w={},C=[],H="",I="",J="",K="";b.setup=function(a,b,c){a&&b||console.error("Invalid parameters. Usage: TWAPI.setup(clientid, oauth, callback);");
e=a;m=b;a=document.createElement("div");a.id="twapiJsonpContainer";a.style.cssText="display:none;";document.querySelectorAll("body")[0].appendChild(a);h("https://api.twitch.tv/kraken?client_id="+e+"&oauth_token="+m+"&api_version=3",function(a){x=a.token.user_name;c(x)})};b.runChat=function(a,r){x&&m||console.error("TWAPI not set up, cannot run chat.");n&&b.closeChat();d=a.toLowerCase();h("https://api.twitch.tv/api/channels/"+d+"/chat_properties?api_version=3",function(a){a=a.web_socket_servers[Math.floor(Math.random()*
a.web_socket_servers.length)];n=new WebSocket("ws://"+a);n.onopen=function(a){n.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");n.send("PASS oauth:"+m);n.send("NICK "+x);n.send("JOIN #"+d)};n.onmessage=function(a){a=a.data.split("\r\n");for(var b=0;b<a.length;b++){var c=a[b];if("PING :tmi.twitch.tv"===c)n.send("PONG :tmi.twitch.tv");else if(c){q("twapiRaw",c);var f=c.split(" ");if("PRIVMSG"===f[2]){c=f[0];f.splice(0,1);for(var r=f,e=c.split(";"),c="#d2691e",p=f=!1,h=!1,m="",
k="",l=0;l<e.length;l++){e[l]=e[l].split("=");var t=e[l][0],g=e[l][1];"display-name"===t?m=""===g?r[0].split("!")[0].substring(1):g:"@color"===t&&""!=g?c=g:"mod"===t&&"1"==g?f=!0:"subscriber"===t&&"1"==g?p=!0:"turbo"===t&&"1"==g?h=!0:"emotes"===t&&""!=g&&(k=g)}e=!1;l=r[3].substring(1);r.splice(0,4);r=r.join(" ");"\u0001ACTION"===l?(l=r,e=!0):l+=" "+r;r=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");q("twapiMsg",{from:m,color:c,mod:f,sub:p,turbo:h,streamer:m.toLowerCase()===d.toLowerCase(),action:e,text:r,
emotes:k})}else if("PRIVMSG"===f[1])q("twapiHost",f[3].substring(1));else if("NOTICE"===f[2])f.splice(0,4),c=f.join(" ").substring(1),q("twapiNotice",c);else if("JOIN"===f[1])c=f[0].split("!")[0].substring(1),q("twapiJoin",c);else if("PART"===f[1])c=f[0].split("!")[0].substring(1),q("twapiPart",c);else if("ROOMSTATE"===f[2]){k=f[0].substring(1).split(";");m=h=p=f=c=void 0;for(m in k)k=m.split("="),"broadcaster-lang"===k[0]?c=k[1]:"r9k"===k[0]?f=k[1]:"slow"===k[0]?p=k[1]:"subs-only"===k[0]&&(h=k[1]);
q("twapiRoomstate",{lang:c,r9k:f,slow:p,subs_only:h})}else"CLEARCHAT"===f[1]&&(c=f[3].substring(1),q("twapiClear",c))}}};N();P();r&&r()});p=new WebSocket("ws://group-ws.tmi.twitch.tv");p.onopen=function(a){p.send("CAP REQ :twitch.tv/commands twitch.tv/tags");p.send("PASS oauth:"+m);p.send("NICK "+x)};p.onmessage=function(a){a=a.data.split("\r\n");for(var b=0;b<a.length;b++){var d=a[b];if("PING :tmi.twitch.tv"===d)p.send("PONG :tmi.twitch.tv");else if(d)if(q("twapiRawGroup",d),d=d.split(" "),"NOTICE"===
d[2])q("twapiGroupNotice",d.slice(4).join(" ").substring(1));else if("WHISPER"===d[2]){for(var r="#d2691e",f="",e=!1,m="",h="",n="",u="",k=d[0].split(";"),l=0;l<k.length;l++){k[l]=k[l].split("=");var t=k[l][0],g=k[l][1];"display-name"===t?m=""===g?d[1].split("!")[0].substring(1):g:"@color"===t&&""!=g?r=g:"turbo"===t&&"1"==g?e=!0:"emotes"===t&&""!=g?f=g:"message-id"===t&&""!=g?h=g:"thread-id"===t&&""!=g?n=g:"user-id"===t&&""!=g&&(u=g)}k=d.slice(4).join(" ").substring(1);q("twapiWhisper",{from:m,to:d[3],
color:r,emotes:f,turbo:e,message_id:h,thread_id:n,user_id:u,text:k})}}}};b.closeChat=function(){if(!n)return console.error("Chat is not open.");n.close();p.close();console.log("Chat closed.");p=n=d="";v=!1;M=F=E=D=A=B=G=u=z=y="";w={};C=[];K=J=I=H=""};b.sendChat=function(a){if(!n)return console.error("Chat is not open.");n.send("PRIVMSG #"+d+" :"+a)};b.sendWhisper=function(a,b){if(!p)return console.error("Group chat is not open.");p.send("PRIVMSG #jtv :/w "+a+" "+b)};b.getUsername=function(){return x};
b.getChannel=function(){return d};b.isOnline=function(){return d?v:console.error("Not in a channel.")};b.getStatus=function(){return d?z:console.error("Not in a channel.")};b.getGame=function(){return d?y:console.error("Not in a channel.")};b.getFollowerCount=function(){return d?u:console.error("Not in a channel.")};b.getTotalViewCount=function(){return d?G:console.error("Not in a channel.")};b.isPartner=function(){return d?B:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return d?
A:console.error("Not in a channel.")};b.getFps=function(){return v?D:console.error("Stream not online.")};b.getVideoHeight=function(){return v?E:console.error("Stream not online.")};b.getDelay=function(){return v?F:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return d?M:console.error("Not in a channel.")};b.getChatters=function(){return d?w:console.error("Not in a channel.")};b.getCreatedAt=function(){return d?H:console.error("Not in a channel.")};b.getLogo=function(){return d?
I:console.error("Not in a channel.")};b.getVideoBanner=function(){return d?J:console.error("Not in a channel.")};b.getProfileBanner=function(){return d?K:console.error("Not in a channel.")};b.isFollowing=function(a,b,c){h("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+b+"?api_version=3&client_id="+e,function(a){a.error?c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,b,c){h("https://api.twitch.tv/kraken/channels/"+
b+"/subscriptions/"+a+"?api_version=3client_id="+e,function(a){a.error?c({isSubscribing:!1}):c({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){B||console.error("Not a partner, cannot run a commercial.");d||console.error("Not in a channel.");a||(a=30);var b="https://api.twitch.tv/kraken/channels/"+d+"/commercial",b=b+("?oauth_token="+m),c=new XMLHttpRequest;c.open("POST",b,!0);c.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");
c.send("length="+a)};b.setStatusGame=function(a,b){a||(a=z);b||(b=y);var c="https://api.twitch.tv/kraken/channels/"+d,c=c+("?channel[status]="+encodeURIComponent(a)),c=c+("&channel[game]="+encodeURIComponent(b)),c=c+("&_method=put&oauth_token="+m),e=new XMLHttpRequest;e.open("GET",c,!0);e.onload=function(){if(200<=e.status&&400>e.status){var a=JSON.parse(e.responseText);y=a.game;z=a.status}else console.error(e.responseText)};e.onerror=function(){console.error(e.responseText)};e.send()};return b}function q(h,
q){var b=new CustomEvent(h,{detail:q});document.dispatchEvent(b)}function h(h,q){var b;do b="jsonp"+Math.floor(1E6*Math.random());while(u[b]);u[b]=function(e){q(e);delete u[b]};var e=document.createElement("script");e.src=h+"&callback="+b;document.querySelector("#twapiJsonpContainer").appendChild(e)}"undefined"===typeof TWAPI?u.TWAPI=O():console.error("TWAPI already defined.")})(window);
