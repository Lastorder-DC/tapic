/**
 * @overview Twitch API & Chat in javascript.
 * @author Skhmt
 * @license MIT
 * @version 3.2.0
 */

 (function(){function t(){function q(a){var e=new Map;a=a.substring(1).split(";");for(var f=0;f<a.length;f++){var c=a[f].split("=");e.set(c[0],c[1])}return e}function p(a,e){function f(){d&&u&&g&&U&&("function"===typeof e&&e(),l("update"))}if(c){var d=!1,u=!1,g=!1,U=!1;n("https://api.twitch.tv/kraken/streams/"+c+"?client_id="+m+"&api_version=3",function(a){a.stream?(v=!0,C=a.stream.viewers,G=a.stream.average_fps,H=a.stream.video_height,I=a.stream.delay):v=!1;d=!0;f()});n("https://api.twitch.tv/kraken/channels/"+
 c+"?client_id="+m+"&api_version=3",function(a){y=a.game;z=a.status;J=a.followers;K=a.views;D=a.partner;L=a.created_at;M=a.logo;N=a.video_banner;O=a.profile_banner;u=!0;f()});n("https://api.twitch.tv/kraken/channels/"+c+"/follows?client_id="+m+"&api_version=3&limit=100",function(a){if(a.follows){var e=!0;0<E.length&&(e=!1);for(var b=0;b<a.follows.length;b++){var c=a.follows[b].user.display_name;-1===E.indexOf(c)&&(e||l("follow",c),E.push(c))}g=!0;f()}});n("https://tmi.twitch.tv/group/user/"+c+"/chatters?client_id="+
 m+"&api_version=3",function(a){r||(a=a.data);if(!a.chatters)return console.log("No response for user list.");C=a.chatter_count;w.moderators=a.chatters.moderators.slice();w.staff=a.chatters.staff.slice();w.admins=a.chatters.admins.slice();w.global_mods=a.chatters.global_mods.slice();w.viewers=a.chatters.viewers.slice();U=!0;f()});setTimeout(function(){r||(document.getElementById("tapicJsonpContainer").innerHTML="");p(a)},1E3*a)}}function X(a){n("https://api.twitch.tv/kraken/chat/"+c+"/badges?api_version=3&client_id="+
 m,function(e){e.subscriber&&(P=e.subscriber.image);"function"==typeof a&&a()})}function n(a,e){if("function"!==typeof e)return console.error("Callback needed.");if(r)require("https").get(a,function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?e(JSON.parse(c)):console.error(c)})}).on("error",function(a){console.error(a.message)});else{var f;do f="tapicJSONP"+Math.floor(65536*Math.random());while(window[f]);window[f]=function(a){e(a);
 delete window[f]};var c=document.createElement("script");c.src=a+"&callback="+f;document.getElementById("tapicJsonpContainer").appendChild(c)}}function l(a,c){if(x.has(a))for(var f=x.get(a),d=0;d<f.length;d++)f[d](c)}var d={},m="",A="",F="",g,r=!1,x=new Map,c="",v=!1,y="",z="",J="",K="",D="",C="",G="",H="",I="",P="",w={},E=[],L="",M="",N="",O="",t="",V="",W="",Q="",R="",S="",T="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(r=!0);d.setup=function(a,e,f){"string"!=typeof a||"string"!=
 typeof e?console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);"):(m=a,A=e.replace("oauth:",""),r||(a=document.createElement("div"),a.id="tapicJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a)),n("https://api.twitch.tv/kraken?client_id="+m+"&oauth_token="+A+"&api_version=3",function(a){function e(){g.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");g.send("PASS oauth:"+A);g.send("NICK "+F)}function d(a){a=
 r?a.split("\r\n"):a.data.split("\r\n");for(var e=0;e<a.length;e++){var B=a[e];if("PING :tmi.twitch.tv"===B)g.send("PONG :tmi.twitch.tv");else if(B){var b=B;l("raw",b);b=b.split(" ");if("PRIVMSG"===b[2]){var k=b,b=q(k[0]);b.get("display-name")||b.set("display-name",k[1].split("!")[0].substring(1));b.get("color")||b.set("color","#d2691e");b.set("badges",b.get("badges").split(","));var h=!1,k=k.slice(4);k[0]=k[0].substring(1);"\u0001ACTION"===k[0]&&(k=k.slice(1),h=!0);var u=k.join(" ").replace(/</g,
 "&lt;").replace(/>/g,"&gt;");"twitchnotify"===b.get("display-name")?"just"===k[1]?l("sub",k[0]):l("subsAway",k[0]):l("message",{from:b.get("display-name"),color:b.get("color"),mod:1==b.get("mod"),sub:1==b.get("subscriber"),turbo:1==b.get("turbo"),streamer:b.get("display-name").toLowerCase()===c.toLowerCase(),action:h,text:u,emotes:b.get("emotes"),badges:b.get("badges"),room_id:b.get("room-id"),user_id:b.get("user-id")})}else if("PRIVMSG"===b[1])l("host",b[3].substring(1));else if("NOTICE"===b[2])b.splice(0,
 4),b=b.join(" ").substring(1),l("notice",b);else if("JOIN"===b[1])b=b[0].split("!")[0].substring(1),l("join",b);else if("PART"===b[1])b=b[0].split("!")[0].substring(1),l("part",b);else if("ROOMSTATE"===b[2])b=q(b[0]),l("roomstate",{lang:b.get("broadcaster-lang"),r9k:b.get("r9k"),slow:b.get("slow"),subs_only:b.get("subs-only")});else if("WHISPER"===b[2])h=q(b[0]),h.get("display-name")||h.set("display-name",b[1].split("!")[0].substring(1)),h.get("color")||h.set("color","#d2691e"),h.set("badges",h.get("badges").split(",")),
 k=b.slice(4).join(" ").substring(1),l("whisper",{from:h.get("display-name"),to:b[3],color:h.get("color"),emotes:h.get("emotes"),turbo:1==h.get("turbo"),message_id:h.get("message-id"),thread_id:h.get("thread-id"),user_id:h.get("user-id"),text:k,badges:h.get("badges")});else if("CLEARCHAT"===b[1])l("clearChat");else if("CLEARCHAT"===b[2]){for(var k=b,u=k[0].slice(1).split(";"),b="",h=1,m=0;m<u.length;m++){var n=u[m].split("=");"ban-duration"===n[0]?h=n[1]:"ban-reason"===n[0]&&(b=n[1].replace(/\\s/g,
 " "))}k=k[4].slice(1);l("clearUser",{name:k,reason:b,duration:h})}else"USERSTATE"===b[2]?(b=q(b[0]),V=b.get("color"),t=b.get("display-name"),W=b.get("emote-sets"),Q=b.get("mod"),R=b.get("subscriber"),S=b.get("turbo"),T=b.get("user-type")):"USERNOTICE"===b[2]&&(h=b,b=q(h[0]),h=h.slice(4).join(" ").substring(1),l("subMonths",{name:b.get("display-name"),months:b.get("msg-param-months"),message:h}));":tmi.twitch.tv 001"===B.substring(0,18)&&"function"==typeof f&&f(F)}}}F=a.token.user_name;g=r?new (require("ws"))("wss://irc-ws.chat.twitch.tv:443"):
 new WebSocket("wss://irc-ws.chat.twitch.tv:443");r?(g.on("open",e),g.on("message",d)):(g.onopen=e,g.onmessage=d)}))};d.joinChannel=function(a,e){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.joinChannel(channel);");else{if(!g)return console.error("Tapic not setup.");c&&g.send("PART #"+c);c=a.replace("#","");v=!1;P=I=H=G=C=D=K=J=z=y="";w={};E=[];T=S=R=Q=O=N=M=L="";g.send("JOIN #"+c);X();"function"==typeof e?p(5,e):p(5)}};d.sendChat=function(a){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.sendChat(message);");
 else{if(!g)return console.error("Tapic not setup.");g.send("PRIVMSG #"+c+" :"+a);l("echoChat",a)}};d.sendWhisper=function(a,e){if("string"!=typeof a||"string"!=typeof e)console.error("Invalid parameters. Usage: TAPIC.sendWhisper(user, message);");else{if(!g)return console.error("Tapic not setup.");g.send("PRIVMSG #jtv :/w "+a+" "+e);l("echoWhisper",{to:a,text:e})}};d.getUsername=function(){return F};d.getChannel=function(){return c};d.isOnline=function(){return c?v:console.error("Not in a channel.")};
 d.getStatus=function(){return c?z:console.error("Not in a channel.")};d.getGame=function(){return c?y:console.error("Not in a channel.")};d.getFollowerCount=function(){return c?J:console.error("Not in a channel.")};d.getTotalViewCount=function(){return c?K:console.error("Not in a channel.")};d.isPartner=function(){return c?D:console.error("Not in a channel.")};d.getCurrentViewCount=function(){return c?C:console.error("Not in a channel.")};d.getFps=function(){return v?G:console.error("Stream not online.")};
 d.getVideoHeight=function(){return v?H:console.error("Stream not online.")};d.getDelay=function(){return v?I:console.error("Stream not online.")};d.getSubBadgeUrl=function(){return c?P:console.error("Not in a channel.")};d.getChatters=function(){return c?w:console.error("Not in a channel.")};d.getCreatedAt=function(){return c?L:console.error("Not in a channel.")};d.getLogo=function(){return c?M:console.error("Not in a channel.")};d.getVideoBanner=function(){return c?N:console.error("Not in a channel.")};
 d.getProfileBanner=function(){return c?O:console.error("Not in a channel.")};d.getDisplayName=function(){return c?t:console.error("Not in a channel.")};d.getColor=function(){return c?V:console.error("Not in a channel.")};d.getEmoteSets=function(){return c?W:console.error("Not in a channel.")};d.getMod=function(){return c?1==Q:console.error("Not in a channel.")};d.getSub=function(){return c?1==R:console.error("Not in a channel.")};d.getTurbo=function(){return c?1==S:console.error("Not in a channel.")};
 d.getUserType=function(){return c?T:console.error("Not in a channel.")};d.isFollowing=function(a,e,c){"string"!=typeof a||"string"!=typeof e||"function"!=typeof c?console.error("Invalid parameters. Usage: TAPIC.isFollowing(user, channel, callback);"):n("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+e+"?api_version=3&client_id="+m,function(a){a.error?c({isFollowing:!1}):c({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};d.isSubscribing=function(a,e,d){"string"!=
 typeof a||"function"!=typeof d?console.error("Invalid parameters. Usage: TAPIC.isSubscribing(user, callback);"):n("https://api.twitch.tv/kraken/channels/"+c+"/subscriptions/"+a+"?api_version=3client_id="+m,function(a){a.error?d({isSubscribing:!1}):d({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};d.runCommercial=function(a){if("number"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.runCommercial(length);");else{if(!c)return console.error("Not in a channel.");
 if(!D)return console.error("Not a partner, cannot run a commercial.");var e="/kraken/channels/"+c+"/commercial?oauth_token="+A,d="https://api.twitch.tv"+e;r?(d={host:"https://api.twitch.tv",path:e,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Client-ID":m}},require("https").request(d).write("length="+a).end()):(e=new XMLHttpRequest,e.open("POST",d,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),e.setRequestHeader("Client-ID",
 m),e.send("length="+a))}};d.setStatusGame=function(a,d){if("string"!=typeof a||"string"!=typeof d)console.error("Invalid parameters. Usage: TAPIC.setStatusGame(status, game);");else{var f="/kraken/channels/"+c,f=f+("?channel[status]="+encodeURIComponent(a)),f=f+("&channel[game]="+encodeURIComponent(d)),f=f+("&_method=put&oauth_token="+A);if(r)f={host:"https://api.twitch.tv",path:f,headers:{"Client-ID":m}},require("https").get(f,function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=
 a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var d=JSON.parse(c);y=d.game;z=d.status}else console.error(c)})}).on("error",function(a){console.error(a.message)});else{var g=new XMLHttpRequest;g.open("GET","https://api.twitch.tv"+f,!0);g.setRequestHeader("Client-ID",m);g.onload=function(){if(200<=g.status&&400>g.status){var a=JSON.parse(g.responseText);y=a.game;z=a.status}else console.error(g.responseText)};g.onerror=function(){console.error(g.responseText)};g.send()}}};d.listen=
 function(a,c){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.listen(eventName[, callback]);");else{if("function"!==typeof c)return console.error("Callback needed.");if(x.has(a)){var d=x.get(a);d.push(c);x.set(a,d)}else x.set(a,[c])}};d.emit=function(a,c){"string"!=typeof a||"string"!=typeof c?console.error("Invalid parameters. Usage: TAPIC.emit(eventName, eventDetail);"):l(a,c)};return d}"function"!==typeof Map&&(window.Map=function(){var q=Object.create(null),p={size:0,get:function(p){return q[p]},
 set:function(t,n){q[t]=n;p.size++},has:function(p){return!!q[p]},clear:function(){q=Object.create(null);p.size=0}};return p});"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=t():"undefined"===typeof TAPIC?window.TAPIC=t():console.error("TAPIC already defined.")})();
