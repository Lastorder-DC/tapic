/**
 * @overview Twitch API & Chat in javascript.
 * @author Skhmt
 * @license MIT
 * @version 3.2.1
 */

 (function(){function t(){function p(a){var d=new Map;a=a.substring(1).split(";");for(var r=0;r<a.length;r++){var e=a[r].split("=");d.set(e[0],e[1])}return d}function l(a,d){function r(){b&&u&&f&&U&&("function"===typeof d&&d(),k("update"))}if(e){var b=!1,u=!1,f=!1,U=!1;m("https://api.twitch.tv/kraken/streams/"+e,function(a){a.stream?(n=!0,C=a.stream.viewers,G=a.stream.average_fps,H=a.stream.video_height,I=a.stream.delay):n=!1;b=!0;r()});m("https://api.twitch.tv/kraken/channels/"+e,function(a){y=a.game;
z=a.status;J=a.followers;K=a.views;D=a.partner;L=a.created_at;M=a.logo;N=a.video_banner;O=a.profile_banner;u=!0;r()});m("https://api.twitch.tv/kraken/channels/"+e+"/follows","&limit=100",function(a){if(a.follows){var d=!0;0<E.length&&(d=!1);for(var c=0;c<a.follows.length;c++){var e=a.follows[c].user.display_name;-1===E.indexOf(e)&&(d||k("follow",e),E.push(e))}f=!0;r()}});m("https://tmi.twitch.tv/group/user/"+e+"/chatters",function(a){q||(a=a.data);if(!a.chatters)return console.log("No response for user list.");
C=a.chatter_count;v.moderators=a.chatters.moderators.slice();v.staff=a.chatters.staff.slice();v.admins=a.chatters.admins.slice();v.global_mods=a.chatters.global_mods.slice();v.viewers=a.chatters.viewers.slice();U=!0;r()});setTimeout(function(){q||(document.getElementById("tapicJsonpContainer").innerHTML="");l(a)},1E3*a)}}function X(a){m("https://api.twitch.tv/kraken/chat/"+e+"/badges",function(d){d.subscriber&&(P=d.subscriber.image);"function"==typeof a&&a()})}function m(a,d,e){a=a+("?oauth_token="+
A)+"&api_version=3"+("&client_id="+w);"string"===typeof d?a+=d:"function"===typeof d&&(e=d);if("function"!==typeof e)return console.error("Callback needed.");if(q)require("https").get(a,function(a){var d="";a.setEncoding("utf8");a.on("data",function(a){d+=a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?e(JSON.parse(d)):console.error(d)})}).on("error",function(a){console.error(a.message)});else{var b;do b="tapicJSONP"+Math.floor(65536*Math.random());while(window[b]);window[b]=function(a){e(a);
delete window[b]};d=document.createElement("script");d.src=a+"&callback="+b;document.getElementById("tapicJsonpContainer").appendChild(d)}}function k(a,d){if(x.has(a))for(var e=x.get(a),b=0;b<e.length;b++)e[b](d)}var b={},w="",A="",F="",f,q=!1,x=new Map,e="",n=!1,y="",z="",J="",K="",D="",C="",G="",H="",I="",P="",v={},E=[],L="",M="",N="",O="",t="",V="",W="",Q="",R="",S="",T="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(q=!0);b.setup=function(a,d,b){"string"!=typeof a||"string"!=
typeof d?console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);"):(w=a,A=d.replace("oauth:",""),q||(a=document.createElement("div"),a.id="tapicJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a)),m("https://api.twitch.tv/kraken",function(a){function d(){f.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");f.send("PASS oauth:"+A);f.send("NICK "+F)}function m(a){a=q?a.split("\r\n"):a.data.split("\r\n");
for(var d=0;d<a.length;d++){var B=a[d];if("PING :tmi.twitch.tv"===B)f.send("PONG :tmi.twitch.tv");else if(B){var c=B;k("raw",c);c=c.split(" ");if("PRIVMSG"===c[2]){var h=c,c=p(h[0]);c.get("display-name")||c.set("display-name",h[1].split("!")[0].substring(1));c.get("color")||c.set("color","#d2691e");c.set("badges",c.get("badges").split(","));var g=!1,h=h.slice(4);h[0]=h[0].substring(1);"\u0001ACTION"===h[0]&&(h=h.slice(1),g=!0);var u=h.join(" ").replace(/</g,"&lt;").replace(/>/g,"&gt;");"twitchnotify"===
c.get("display-name")?"just"===h[1]?k("sub",h[0]):k("subsAway",h[0]):k("message",{from:c.get("display-name"),color:c.get("color"),mod:1==c.get("mod"),sub:1==c.get("subscriber"),turbo:1==c.get("turbo"),streamer:c.get("display-name").toLowerCase()===e.toLowerCase(),action:g,text:u,emotes:c.get("emotes"),badges:c.get("badges"),room_id:c.get("room-id"),user_id:c.get("user-id")})}else if("PRIVMSG"===c[1])k("host",c[3].substring(1));else if("NOTICE"===c[2])c.splice(0,4),c=c.join(" ").substring(1),k("notice",
c);else if("JOIN"===c[1])c=c[0].split("!")[0].substring(1),k("join",c);else if("PART"===c[1])c=c[0].split("!")[0].substring(1),k("part",c);else if("ROOMSTATE"===c[2])c=p(c[0]),k("roomstate",{lang:c.get("broadcaster-lang"),r9k:c.get("r9k"),slow:c.get("slow"),subs_only:c.get("subs-only")});else if("WHISPER"===c[2])g=p(c[0]),g.get("display-name")||g.set("display-name",c[1].split("!")[0].substring(1)),g.get("color")||g.set("color","#d2691e"),g.set("badges",g.get("badges").split(",")),h=c.slice(4).join(" ").substring(1),
k("whisper",{from:g.get("display-name"),to:c[3],color:g.get("color"),emotes:g.get("emotes"),turbo:1==g.get("turbo"),message_id:g.get("message-id"),thread_id:g.get("thread-id"),user_id:g.get("user-id"),text:h,badges:g.get("badges")});else if("CLEARCHAT"===c[1])k("clearChat");else if("CLEARCHAT"===c[2]){for(var h=c,u=h[0].slice(1).split(";"),c="",g=1,l=0;l<u.length;l++){var n=u[l].split("=");"ban-duration"===n[0]?g=n[1]:"ban-reason"===n[0]&&(c=n[1].replace(/\\s/g," "))}h=h[4].slice(1);k("clearUser",
{name:h,reason:c,duration:g})}else"USERSTATE"===c[2]?(c=p(c[0]),V=c.get("color"),t=c.get("display-name"),W=c.get("emote-sets"),Q=c.get("mod"),R=c.get("subscriber"),S=c.get("turbo"),T=c.get("user-type")):"USERNOTICE"===c[2]&&(g=c,c=p(g[0]),g=g.slice(4).join(" ").substring(1),k("subMonths",{name:c.get("display-name"),months:c.get("msg-param-months"),message:g}));":tmi.twitch.tv 001"===B.substring(0,18)&&"function"==typeof b&&b(F)}}}F=a.token.user_name;f=q?new (require("ws"))("wss://irc-ws.chat.twitch.tv:443"):
new WebSocket("wss://irc-ws.chat.twitch.tv:443");q?(f.on("open",d),f.on("message",m)):(f.onopen=d,f.onmessage=m)}))};b.joinChannel=function(a,d){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.joinChannel(channel);");else{if(!f)return console.error("Tapic not setup.");e&&f.send("PART #"+e);e=a.replace("#","");n=!1;P=I=H=G=C=D=K=J=z=y="";v={};E=[];T=S=R=Q=O=N=M=L="";f.send("JOIN #"+e);X();"function"==typeof d?l(5,d):l(5)}};b.sendChat=function(a){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.sendChat(message);");
else{if(!f)return console.error("Tapic not setup.");f.send("PRIVMSG #"+e+" :"+a);k("echoChat",a)}};b.sendWhisper=function(a,d){if("string"!=typeof a||"string"!=typeof d)console.error("Invalid parameters. Usage: TAPIC.sendWhisper(user, message);");else{if(!f)return console.error("Tapic not setup.");f.send("PRIVMSG #jtv :/w "+a+" "+d);k("echoWhisper",{to:a,text:d})}};b.getUsername=function(){return F};b.getChannel=function(){return e};b.isOnline=function(){return e?n:console.error("Not in a channel.")};
b.getStatus=function(){return e?z:console.error("Not in a channel.")};b.getGame=function(){return e?y:console.error("Not in a channel.")};b.getFollowerCount=function(){return e?J:console.error("Not in a channel.")};b.getTotalViewCount=function(){return e?K:console.error("Not in a channel.")};b.isPartner=function(){return e?D:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return e?C:console.error("Not in a channel.")};b.getFps=function(){return n?G:console.error("Stream not online.")};
b.getVideoHeight=function(){return n?H:console.error("Stream not online.")};b.getDelay=function(){return n?I:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return e?P:console.error("Not in a channel.")};b.getChatters=function(){return e?v:console.error("Not in a channel.")};b.getCreatedAt=function(){return e?L:console.error("Not in a channel.")};b.getLogo=function(){return e?M:console.error("Not in a channel.")};b.getVideoBanner=function(){return e?N:console.error("Not in a channel.")};
b.getProfileBanner=function(){return e?O:console.error("Not in a channel.")};b.getDisplayName=function(){return e?t:console.error("Not in a channel.")};b.getColor=function(){return e?V:console.error("Not in a channel.")};b.getEmoteSets=function(){return e?W:console.error("Not in a channel.")};b.getMod=function(){return e?1==Q:console.error("Not in a channel.")};b.getSub=function(){return e?1==R:console.error("Not in a channel.")};b.getTurbo=function(){return e?1==S:console.error("Not in a channel.")};
b.getUserType=function(){return e?T:console.error("Not in a channel.")};b.isFollowing=function(a,d,e){"string"!=typeof a||"string"!=typeof d||"function"!=typeof e?console.error("Invalid parameters. Usage: TAPIC.isFollowing(user, channel, callback);"):m("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+d,function(a){a.error?e({isFollowing:!1}):e({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,d){"string"!=typeof a||"function"!=typeof d?
console.error("Invalid parameters. Usage: TAPIC.isSubscribing(user, callback);"):m("https://api.twitch.tv/kraken/channels/"+e+"/subscriptions/"+a,function(a){a.error?d({isSubscribing:!1}):d({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){if("number"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.runCommercial(length);");else{if(!e)return console.error("Not in a channel.");if(!D)return console.error("Not a partner, cannot run a commercial.");
var d="/kraken/channels/"+e+"/commercial?oauth_token="+A,b="https://api.twitch.tv"+d;q?(b={host:"https://api.twitch.tv",path:d,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Client-ID":w}},require("https").request(b).write("length="+a).end()):(d=new XMLHttpRequest,d.open("POST",b,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),d.setRequestHeader("Client-ID",w),d.send("length="+a))}};b.setStatusGame=function(a,d){if("string"!=
typeof a||"string"!=typeof d)console.error("Invalid parameters. Usage: TAPIC.setStatusGame(status, game);");else{var b="/kraken/channels/"+e,b=b+("?channel[status]="+encodeURIComponent(a)),b=b+("&channel[game]="+encodeURIComponent(d)),b=b+("&_method=put&oauth_token="+A);if(q)b={host:"https://api.twitch.tv",path:b,headers:{"Client-ID":w}},require("https").get(b,function(a){var d="";a.setEncoding("utf8");a.on("data",function(a){d+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var b=
JSON.parse(d);y=b.game;z=b.status}else console.error(d)})}).on("error",function(a){console.error(a.message)});else{var f=new XMLHttpRequest;f.open("GET","https://api.twitch.tv"+b,!0);f.setRequestHeader("Client-ID",w);f.onload=function(){if(200<=f.status&&400>f.status){var a=JSON.parse(f.responseText);y=a.game;z=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()}}};b.listen=function(a,d){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.listen(eventName[, callback]);");
else{if("function"!==typeof d)return console.error("Callback needed.");if(x.has(a)){var b=x.get(a);b.push(d);x.set(a,b)}else x.set(a,[d])}};b.emit=function(a,b){"string"!=typeof a||"string"!=typeof b?console.error("Invalid parameters. Usage: TAPIC.emit(eventName, eventDetail);"):k(a,b)};return b}"function"!==typeof Map&&(window.Map=function(){var p=Object.create(null),l={size:0,get:function(l){return p[l]},set:function(t,m){p[t]=m;l.size++},has:function(l){return!!p[l]},clear:function(){p=Object.create(null);
l.size=0}};return l});"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports=t():"undefined"===typeof TAPIC?window.TAPIC=t():console.error("TAPIC already defined.")})();
