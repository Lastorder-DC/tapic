// Twitch Websockets & API - TWAPI
// Made by skhmt, 2016
// http://closure-compiler.appspot.com

(function(e){function D(){function c(){p("https://api.twitch.tv/kraken/streams/"+d+"?api_version=3",function(a){a.stream?(m=!0,x=a.stream.viewers,y=a.stream.average_fps,z=a.stream.video_height,A=a.stream.delay):m=!1});p("https://api.twitch.tv/kraken/channels/"+d+"?client_id="+n+"&api_version=3",function(a){e=a.game;t=a.status;B=a.followers;C=a.views;v=a.partner});p("https://api.twitch.tv/kraken/channels/"+d+"/follows?client_id="+n+"&api_version=3",function(a){});setTimeout(function(){c()},6E4)}function E(){p("https://api.twitch.tv/kraken/chat/"+
d+"/badges?api_version=3",function(a){null!=a.subscriber&&(subBadgeUrl=a.subscriber.image)})}var b={},n="",h="",r="",d="",k,m=!1,e="",t="",B="",C="",v="",x="",y="",z="",A="";b.setup=function(a,b,d){a&&b||console.error("Invalid parameters. Usage: TWAPI.setup(clientid, oauth, callback);");n=a;h=b;p("https://api.twitch.tv/kraken?client_id="+n+"&oauth_token="+h+"&api_version=3",function(a){r=a.token.user_name;d(r)})};b.runChat=function(a,b){r&&h||console.error("TWAPI not set up, cannot run chat.");d=
a;p("https://api.twitch.tv/api/channels/"+a+"/chat_properties?api_version=3",function(a){a=a.web_socket_servers[Math.floor(Math.random()*a.web_socket_servers.length)];k=new WebSocket("ws://"+a);k.onopen=function(a){k.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");k.send("PASS oauth:"+h);k.send("NICK "+r);k.send("JOIN #"+d)};k.onmessage=function(a){a=a.data.split("\r\n");for(var b=0;b<a.length;b++){var g=a[b];if("PING :tmi.twitch.tv"===g)k.send("PONG :tmi.twitch.tv"),console.log("PONG");
else{var f=g;u("twapiRaw",f);g=f.split(" ");if("PRIVMSG"===g[2]){f=g[0];g.splice(0,1);for(var e=g,h=f.split(";"),g="#d2691e",m=f=!1,n=!1,w="",l=0;l<h.length;l++){h[l]=h[l].split("=");var c=h[l][0],q=h[l][1];"display-name"==c?w=""===q?e[0].split("!")[0]:q:"@color"==c&&""!=q?g=q:"mod"==c&&"1"==q?f=!0:"subscriber"==c&&"1"==q?m=!0:"turbo"==c&&"1"==q&&(n=!0)}h=!1;l=e[3].substring(1);e.splice(0,4);e=e.join(" ");"\u0001ACTION"===l?(l=e,h=!0):l+=" "+e;e=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");u("twapiMsg",
{from:w,color:g,mod:f,sub:m,turbo:n,streamer:w.toLowerCase()===d.toLowerCase(),action:h,text:e})}else"NOTICE"===g[2]?(g.splice(0,4),g=g.join(" ").substring(1),u("twapiNotice",g)):"JOIN"===g[1]?(g=g[0].split("!")[0].substring(1),u("twapiJoin",g)):console.log(f)}}};c();E();b(d)})};b.closeChat=function(){if(!k)return console.error("Chat is not open.");k.close();console.log("Chat closed.")};b.sendChat=function(a){if(!k)return console.error("Chat is not open.");k.send("PRIVMSG #"+d+" :"+a)};b.getUsername=
function(){return r};b.getChannel=function(){return d};b.isOnline=function(a){d||console.error("Not in a channel.");return m};b.getStatus=function(){d||console.error("Not in a channel.");return t};b.getGame=function(){d||console.error("Not in a channel.");return e};b.getFollowers=function(){d||console.error("Not in a channel.");return B};b.getViews=function(){d||console.error("Not in a channel.");return C};b.isPartner=function(){d||console.error("Not in a channel.");return v};b.getCurrentViewers=
function(){m||console.error("Stream not online.");return x};b.getFps=function(){m||console.error("Stream not online.");return y};b.getVideoHeight=function(){m||console.error("Stream not online.");return z};b.getDelay=function(){m||console.error("Stream not online.");return A};b.getSubBadgeUrl=function(){d||console.error("Not in a channel.");return""};b.runCommercial=function(a){v||console.error("Not a partner, cannot run a commercial.");d||console.error("Not in a channel.");a||(a=30);var b="https://api.twitch.tv/kraken/channels/"+
d+"/commercial",b=b+("?oauth_token="+h),f=new XMLHttpRequest;f.open("POST",b,!0);f.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");f.send("length="+a)};b.setStatusGame=function(a,b){a||(a=t);b||(b=e);var f="https://api.twitch.tv/kraken/channels/"+d,f=f+("?channel[status]="+encodeURIComponent(a)),f=f+("&channel[game]="+encodeURIComponent(b)),f=f+("&_method=put&oauth_token="+h),c=new XMLHttpRequest;c.open("GET",f,!0);c.onload=function(){if(200<=c.status&&400>c.status){var a=
JSON.parse(c.responseText);e=a.game;t=a.status}else console.error(c.responseText)};c.onerror=function(){console.error(c.responseText)};c.send()};return b}function u(c,e){var b=new CustomEvent(c,{detail:e});document.dispatchEvent(b)}function p(c,p){var b;do b="jsonp"+Math.floor(1E6*Math.random());while(e[b]);e[b]=function(c){p(c);delete e[b]};var n=document.createElement("script");n.src=c+"&callback="+b;document.querySelectorAll("head")[0].appendChild(n)}"undefined"===typeof TWAPI?e.TWAPI=D():console.error("TWAPI already defined.")})(window);
