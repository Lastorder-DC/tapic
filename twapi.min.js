// Twitch Websockets & API in javascript - TWAPI.js
// Made by skhmt, 2016

(function(g){function G(){function z(){k("https://api.twitch.tv/kraken/streams/"+e+"?api_version=3",function(a){a.stream?(r=!0,x=a.stream.viewers,A=a.stream.average_fps,B=a.stream.video_height,C=a.stream.delay):r=!1});k("https://api.twitch.tv/kraken/channels/"+e+"?client_id="+f+"&api_version=3",function(a){g=a.game;v=a.status;D=a.followers;E=a.views;y=a.partner});k("https://api.twitch.tv/kraken/channels/"+e+"/follows?client_id="+f+"&api_version=3&limit=100",function(a){if(a.follows){var b=!0;0<w.length&&
(b=!1);for(var d=0;d<a.follows.length;d++){var e=a.follows[d].user.display_name;-1===w.indexOf(e)&&(b||q("twapiFollow",e),w.push(e))}}});k("https://tmi.twitch.tv/group/user/"+e+"/chatters?client_id="+f+"&api_version=3",function(a){if(!a.data.chatters)return console.log("No response for user list.");x=a.data.chatter_count;l.moderators=a.data.chatters.moderators.slice();l.staff=a.data.chatters.staff.slice();l.admins=a.data.chatters.admins.slice();l.global_mods=a.data.chatters.global_mods.slice();l.viewers=
a.data.chatters.viewers.slice()});setTimeout(function(){z()},6E4)}function H(){k("https://api.twitch.tv/kraken/chat/"+e+"/badges?api_version=3",function(a){null!=a.subscriber&&(F=a.subscriber.image)})}var b={},f="",m="",u="",e="",n,r=!1,g="",v="",D="",E="",y="",x="",A="",B="",C="",F="",l={},w=[];b.setup=function(a,b,e){a&&b||console.error("Invalid parameters. Usage: TWAPI.setup(clientid, oauth, callback);");f=a;m=b;k("https://api.twitch.tv/kraken?client_id="+f+"&oauth_token="+m+"&api_version=3",function(a){u=
a.token.user_name;e(u)})};b.runChat=function(a,b){u&&m||console.error("TWAPI not set up, cannot run chat.");e=a.toLowerCase();l={};w=[];k("https://api.twitch.tv/api/channels/"+e+"/chat_properties?api_version=3",function(a){a=a.web_socket_servers[Math.floor(Math.random()*a.web_socket_servers.length)];n=new WebSocket("ws://"+a);n.onopen=function(a){n.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");n.send("PASS oauth:"+m);n.send("NICK "+u);n.send("JOIN #"+e)};n.onmessage=function(a){a=
a.data.split("\r\n");for(var b=0;b<a.length;b++){var c=a[b];if("PING :tmi.twitch.tv"===c)n.send("PONG :tmi.twitch.tv"),console.log("PONG");else{var d=c;q("twapiRaw",d);c=d.split(" ");if("PRIVMSG"===c[2]){d=c[0];c.splice(0,1);for(var h=c,g=d.split(";"),c="#d2691e",t=d=!1,k=!1,f="",p=0;p<g.length;p++){g[p]=g[p].split("=");var m=g[p][0],l=g[p][1];"display-name"==m?f=""===l?h[0].split("!")[0]:l:"@color"==m&&""!=l?c=l:"mod"==m&&"1"==l?d=!0:"subscriber"==m&&"1"==l?t=!0:"turbo"==m&&"1"==l&&(k=!0)}g=!1;p=
h[3].substring(1);h.splice(0,4);h=h.join(" ");"\u0001ACTION"===p?(p=h,g=!0):p+=" "+h;h=p.replace(/</g,"&lt;").replace(/>/g,"&gt;");q("twapiMsg",{from:f,color:c,mod:d,sub:t,turbo:k,streamer:f.toLowerCase()===e.toLowerCase(),action:g,text:h})}else if("PRIVMSG"===c[1])q("twapiHost",c[3].substring(1));else if("NOTICE"===c[2])c.splice(0,4),c=c.join(" ").substring(1),q("twapiNotice",c);else if("JOIN"===c[1])c=c[0].split("!")[0].substring(1),q("twapiJoin",c);else if("PART"===c[1])c=c[0].split("!")[0].substring(1),
q("twapiPart",c);else if("ROOMSTATE"===c[2]){h=c[0].split(";");f=k=t=d=c=void 0;for(f in h)h=f.split("="),"@broadcaster-lang"===h[0]?c=h[1]:"r9k"===h[0]?d=h[1]:"slow"===h[0]?t=h[1]:"subs-only"===h[0]&&(k=h[1]);q("twapiRoomstate",{lang:c,r9k:d,slow:t,subs_only:k})}else"CLEARCHAT"===c[1]?(c=c[3].substring(1),q("twapiClear",c)):d&&console.info(d)}}};z();H();b(e)})};b.closeChat=function(){if(!n)return console.error("Chat is not open.");n.close();console.log("Chat closed.")};b.sendChat=function(a){if(!n)return console.error("Chat is not open.");
n.send("PRIVMSG #"+e+" :"+a)};b.getUsername=function(){return u};b.getChannel=function(){return e};b.isOnline=function(a){return e?r:console.error("Not in a channel.")};b.getStatus=function(){return e?v:console.error("Not in a channel.")};b.getGame=function(){return e?g:console.error("Not in a channel.")};b.getFollowerCount=function(){return e?D:console.error("Not in a channel.")};b.getTotalViewCount=function(){return e?E:console.error("Not in a channel.")};b.isPartner=function(){return e?y:console.error("Not in a channel.")};
b.getCurrentViewCount=function(){return e?x:console.error("Not in a channel.")};b.getFps=function(){return r?A:console.error("Stream not online.")};b.getVideoHeight=function(){return r?B:console.error("Stream not online.")};b.getDelay=function(){return r?C:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return e?F:console.error("Not in a channel.")};b.getChatters=function(){return e?l:console.error("Not in a channel.")};b.isFollowing=function(a,b,d){k("https://api.twitch.tv/kraken/users/"+
a+"/follows/channels/"+b+"?api_version=3",function(a){a.error?d({isFollowing:!1}):d({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){y||console.error("Not a partner, cannot run a commercial.");e||console.error("Not in a channel.");a||(a=30);var b="https://api.twitch.tv/kraken/channels/"+e+"/commercial",b=b+("?oauth_token="+m),d=new XMLHttpRequest;d.open("POST",b,!0);d.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");
d.send("length="+a)};b.setStatusGame=function(a,b){a||(a=v);b||(b=g);var d="https://api.twitch.tv/kraken/channels/"+e,d=d+("?channel[status]="+encodeURIComponent(a)),d=d+("&channel[game]="+encodeURIComponent(b)),d=d+("&_method=put&oauth_token="+m),f=new XMLHttpRequest;f.open("GET",d,!0);f.onload=function(){if(200<=f.status&&400>f.status){var a=JSON.parse(f.responseText);g=a.game;v=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()};return b}function q(g,
k){var b=new CustomEvent(g,{detail:k});document.dispatchEvent(b)}function k(k,q){var b;do b="jsonp"+Math.floor(1E6*Math.random());while(g[b]);g[b]=function(f){q(f);delete g[b]};var f=document.createElement("script");f.src=k+"&callback="+b;document.querySelectorAll("head")[0].appendChild(f)}"undefined"===typeof TWAPI?g.TWAPI=G():console.error("TWAPI already defined.")})(window);
