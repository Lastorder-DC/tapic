/**
 * @overview Twitch API & Chat in javascript.
 * @author Skhmt
 * @license MIT
 * @version 3.2.2
 */

 (function(){function r(){function m(a){var d=new Map;a=a.substring(1).split(";");for(var q=0;q<a.length;q++){var e=a[q].split("=");d.set(e[0],e[1])}return d}function n(a,d){function q(){b&&B&&f&&U&&("function"===typeof d&&d(),k("update"))}if(e){var b=!1,B=!1,f=!1,U=!1;l("https://api.twitch.tv/kraken/streams/"+e,function(a){a.stream?(t=!0,C=a.stream.viewers,G=a.stream.average_fps,H=a.stream.video_height,I=a.stream.delay):t=!1;b=!0;q()});l("https://api.twitch.tv/kraken/channels/"+e,function(a){x=a.game;
y=a.status;J=a.followers;K=a.views;D=a.partner;L=a.created_at;M=a.logo;N=a.video_banner;O=a.profile_banner;B=!0;q()});l("https://api.twitch.tv/kraken/channels/"+e+"/follows","&limit=100",function(a){if(a.follows){var d=!0;0<E.length&&(d=!1);for(var c=0;c<a.follows.length;c++){var e=a.follows[c].user.display_name;-1===E.indexOf(e)&&(d||k("follow",e),E.push(e))}f=!0;q()}});l("https://tmi.twitch.tv/group/user/"+e+"/chatters",function(a){p||(a=a.data);if(!a.chatters)return console.log("No response for user list.");
C=a.chatter_count;u.moderators=a.chatters.moderators.slice();u.staff=a.chatters.staff.slice();u.admins=a.chatters.admins.slice();u.global_mods=a.chatters.global_mods.slice();u.viewers=a.chatters.viewers.slice();U=!0;q()});setTimeout(function(){p||(document.getElementById("tapicJsonpContainer").innerHTML="");n(a)},1E3*a)}}function X(a){l("https://api.twitch.tv/kraken/chat/"+e+"/badges",function(d){d.subscriber&&(P=d.subscriber.image);"function"==typeof a&&a()})}function l(a,d,e){a=a+("?oauth_token="+
z)+"&api_version=3"+("&client_id="+v);"string"===typeof d?a+=d:"function"===typeof d&&(e=d);if("function"!==typeof e)return console.error("Callback needed.");if(p)require("https").get(a,function(a){var d="";a.setEncoding("utf8");a.on("data",function(a){d+=a});a.on("end",function(){200<=a.statusCode&&400>a.statusCode?e(JSON.parse(d)):console.error(d)})}).on("error",function(a){console.error(a.message)});else{var b;do b="tapicJSONP"+Math.floor(65536*Math.random());while(window[b]);window[b]=function(a){e(a);
delete window[b]};d=document.createElement("script");d.src=a+"&callback="+b;document.getElementById("tapicJsonpContainer").appendChild(d)}}function k(a,d){if(w.has(a))for(var e=w.get(a),b=0;b<e.length;b++)e[b](d)}var b={},v="",z="",F="",f,p=!1,w=new Map,e="",t=!1,x="",y="",J="",K="",D="",C="",G="",H="",I="",P="",u={},E=[],L="",M="",N="",O="",r="",V="",W="",Q="",R="",S="",T="";"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(p=!0);b.setup=function(a,d,b){"string"!=typeof a||"string"!=
typeof d?console.error("Invalid parameters. Usage: TAPIC.setup(clientid, oauth[, callback]);"):(v=a,z=d.replace("oauth:",""),p||(a=document.createElement("div"),a.id="tapicJsonpContainer",a.style.cssText="display:none;",document.getElementsByTagName("body")[0].appendChild(a)),l("https://api.twitch.tv/kraken",function(a){function d(){f.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");f.send("PASS oauth:"+z);f.send("NICK "+F)}function l(a){a=p?a.split("\r\n"):a.data.split("\r\n");
for(var d=0;d<a.length;d++){var A=a[d];if("PING :tmi.twitch.tv"===A)f.send("PONG :tmi.twitch.tv");else if(A){var c=A;k("raw",c);c=c.split(" ");if("PRIVMSG"===c[2]){var h=c,c=m(h[0]);c.get("display-name")||c.set("display-name",h[1].split("!")[0].substring(1));c.get("color")||c.set("color","#d2691e");c.set("badges",c.get("badges").split(","));var g=!1,h=h.slice(4);h[0]=h[0].substring(1);"\u0001ACTION"===h[0]&&(h=h.slice(1),g=!0);var B=h.join(" ").replace(/</g,"&lt;").replace(/>/g,"&gt;");"twitchnotify"===
c.get("display-name")?"just"===h[1]?k("sub",h[0]):k("subsAway",h[0]):k("message",{from:c.get("display-name"),color:c.get("color"),mod:1==c.get("mod"),sub:1==c.get("subscriber"),turbo:1==c.get("turbo"),streamer:c.get("display-name").toLowerCase()===e.toLowerCase(),action:g,text:B,emotes:c.get("emotes"),badges:c.get("badges"),room_id:c.get("room-id"),user_id:c.get("user-id")})}else"PRIVMSG"===c[1]?k("host",c[3].substring(1)):"NOTICE"===c[2]?(c.splice(0,4),c=c.join(" ").substring(1),k("notice",c)):"JOIN"===
c[1]?(c=c[0].split("!")[0].substring(1),k("join",c)):"PART"===c[1]?(c=c[0].split("!")[0].substring(1),k("part",c)):"ROOMSTATE"===c[2]?(c=m(c[0]),k("roomstate",{lang:c.get("broadcaster-lang"),r9k:c.get("r9k"),slow:c.get("slow"),subs_only:c.get("subs-only")})):"WHISPER"===c[2]?(g=m(c[0]),g.get("display-name")||g.set("display-name",c[1].split("!")[0].substring(1)),g.get("color")||g.set("color","#d2691e"),g.set("badges",g.get("badges").split(",")),h=c.slice(4).join(" ").substring(1),k("whisper",{from:g.get("display-name"),
to:c[3],color:g.get("color"),emotes:g.get("emotes"),turbo:1==g.get("turbo"),message_id:g.get("message-id"),thread_id:g.get("thread-id"),user_id:g.get("user-id"),text:h,badges:g.get("badges")})):"CLEARCHAT"===c[1]?k("clearChat"):"CLEARCHAT"===c[2]?(h=m(c[0]),g=h.get("ban-reason"),"string"===typeof g&&(g=g.replace(/\\s/g," ")),h=h.get("ban-duration"),"undefined"===typeof h&&(h=0),k("clearUser",{name:c[4].slice(1),reason:g,duration:h})):"USERSTATE"===c[2]?(c=m(c[0]),V=c.get("color"),r=c.get("display-name"),
W=c.get("emote-sets"),Q=c.get("mod"),R=c.get("subscriber"),S=c.get("turbo"),T=c.get("user-type")):"USERNOTICE"===c[2]&&(g=c,c=m(g[0]),g=g.slice(4).join(" ").substring(1),k("subMonths",{name:c.get("display-name"),months:c.get("msg-param-months"),message:g}));":tmi.twitch.tv 001"===A.substring(0,18)&&"function"==typeof b&&b(F)}}}F=a.token.user_name;f=p?new (require("ws"))("wss://irc-ws.chat.twitch.tv:443"):new WebSocket("wss://irc-ws.chat.twitch.tv:443");p?(f.on("open",d),f.on("message",l)):(f.onopen=
d,f.onmessage=l)}))};b.joinChannel=function(a,d){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.joinChannel(channel);");else{if(!f)return console.error("Tapic not setup.");e&&f.send("PART #"+e);e=a.replace("#","");t=!1;P=I=H=G=C=D=K=J=y=x="";u={};E=[];T=S=R=Q=O=N=M=L="";f.send("JOIN #"+e);X();"function"==typeof d?n(5,d):n(5)}};b.sendChat=function(a){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.sendChat(message);");else{if(!f)return console.error("Tapic not setup.");
f.send("PRIVMSG #"+e+" :"+a);k("echoChat",a)}};b.sendWhisper=function(a,d){if("string"!=typeof a||"string"!=typeof d)console.error("Invalid parameters. Usage: TAPIC.sendWhisper(user, message);");else{if(!f)return console.error("Tapic not setup.");f.send("PRIVMSG #jtv :/w "+a+" "+d);k("echoWhisper",{to:a,text:d})}};b.getUsername=function(){return F};b.getChannel=function(){return e};b.isOnline=function(){return e?t:console.error("Not in a channel.")};b.getStatus=function(){return e?y:console.error("Not in a channel.")};
b.getGame=function(){return e?x:console.error("Not in a channel.")};b.getFollowerCount=function(){return e?J:console.error("Not in a channel.")};b.getTotalViewCount=function(){return e?K:console.error("Not in a channel.")};b.isPartner=function(){return e?D:console.error("Not in a channel.")};b.getCurrentViewCount=function(){return e?C:console.error("Not in a channel.")};b.getFps=function(){return t?G:console.error("Stream not online.")};b.getVideoHeight=function(){return t?H:console.error("Stream not online.")};
b.getDelay=function(){return t?I:console.error("Stream not online.")};b.getSubBadgeUrl=function(){return e?P:console.error("Not in a channel.")};b.getChatters=function(){return e?u:console.error("Not in a channel.")};b.getCreatedAt=function(){return e?L:console.error("Not in a channel.")};b.getLogo=function(){return e?M:console.error("Not in a channel.")};b.getVideoBanner=function(){return e?N:console.error("Not in a channel.")};b.getProfileBanner=function(){return e?O:console.error("Not in a channel.")};
b.getDisplayName=function(){return e?r:console.error("Not in a channel.")};b.getColor=function(){return e?V:console.error("Not in a channel.")};b.getEmoteSets=function(){return e?W:console.error("Not in a channel.")};b.getMod=function(){return e?1==Q:console.error("Not in a channel.")};b.getSub=function(){return e?1==R:console.error("Not in a channel.")};b.getTurbo=function(){return e?1==S:console.error("Not in a channel.")};b.getUserType=function(){return e?T:console.error("Not in a channel.")};
b.isFollowing=function(a,d,e){"string"!=typeof a||"string"!=typeof d||"function"!=typeof e?console.error("Invalid parameters. Usage: TAPIC.isFollowing(user, channel, callback);"):l("https://api.twitch.tv/kraken/users/"+a+"/follows/channels/"+d,function(a){a.error?e({isFollowing:!1}):e({isFollowing:!0,dateFollowed:(new Date(a.created_at)).toLocaleString()})})};b.isSubscribing=function(a,d){"string"!=typeof a||"function"!=typeof d?console.error("Invalid parameters. Usage: TAPIC.isSubscribing(user, callback);"):
l("https://api.twitch.tv/kraken/channels/"+e+"/subscriptions/"+a,function(a){a.error?d({isSubscribing:!1}):d({isSubscribing:!0,dateSubscribed:(new Date(a.created_at)).toLocaleString()})})};b.runCommercial=function(a){if("number"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.runCommercial(length);");else{if(!e)return console.error("Not in a channel.");if(!D)return console.error("Not a partner, cannot run a commercial.");var d="/kraken/channels/"+e+"/commercial?oauth_token="+z,b="https://api.twitch.tv"+
d;p?(b={host:"https://api.twitch.tv",path:d,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Client-ID":v}},require("https").request(b).write("length="+a).end()):(d=new XMLHttpRequest,d.open("POST",b,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),d.setRequestHeader("Client-ID",v),d.send("length="+a))}};b.setStatusGame=function(a,d){if("string"!=typeof a||"string"!=typeof d)console.error("Invalid parameters. Usage: TAPIC.setStatusGame(status, game);");
else{var b="/kraken/channels/"+e,b=b+("?channel[status]="+encodeURIComponent(a)),b=b+("&channel[game]="+encodeURIComponent(d)),b=b+("&_method=put&oauth_token="+z);if(p)b={host:"https://api.twitch.tv",path:b,headers:{"Client-ID":v}},require("https").get(b,function(a){var d="";a.setEncoding("utf8");a.on("data",function(a){d+=a});a.on("end",function(){if(200<=a.statusCode&&400>a.statusCode){var b=JSON.parse(d);x=b.game;y=b.status}else console.error(d)})}).on("error",function(a){console.error(a.message)});
else{var f=new XMLHttpRequest;f.open("GET","https://api.twitch.tv"+b,!0);f.setRequestHeader("Client-ID",v);f.onload=function(){if(200<=f.status&&400>f.status){var a=JSON.parse(f.responseText);x=a.game;y=a.status}else console.error(f.responseText)};f.onerror=function(){console.error(f.responseText)};f.send()}}};b.listen=function(a,d){if("string"!=typeof a)console.error("Invalid parameters. Usage: TAPIC.listen(eventName[, callback]);");else{if("function"!==typeof d)return console.error("Callback needed.");
if(w.has(a)){var b=w.get(a);b.push(d);w.set(a,b)}else w.set(a,[d])}};b.emit=function(a,b){"string"!=typeof a||"string"!=typeof b?console.error("Invalid parameters. Usage: TAPIC.emit(eventName, eventDetail);"):k(a,b)};return b}"function"!==typeof Map&&(window.Map=function(){var m=Object.create(null),n={size:0,get:function(n){return m[n]},set:function(r,l){m[r]=l;n.size++},has:function(n){return!!m[n]},clear:function(){m=Object.create(null);n.size=0}};return n});"undefined"!==typeof module&&"undefined"!==
typeof module.exports?module.exports=r():"undefined"===typeof TAPIC?window.TAPIC=r():console.error("TAPIC already defined.")})();
